<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manager S√©nior</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(0,0,0,0.7);
      z-index: 100;
    }
    .sos-button {
      background: rgba(255,50,50,0.9);
      color: white;
      border: none;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      font-size: 1.4rem;
      cursor: pointer;
      z-index: 101;
    }
    .ok-button {
      background: rgba(34, 197, 94, 0.9);
      color: white;
      border: none;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 101;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clock-box { text-align: center; margin-top: 8px; }
    .clock { font-size: 1.5rem; font-weight: 700; }
    .date { font-size: 1.1rem; }

    .slideshow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
      cursor: pointer;
    }
    .slideshow img {
      max-width: 98%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(255,255,255,0.1);
    }

    .contacts-grid {
      position: fixed;
      top: 80px;
      left: 20px;
      right: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      z-index: 90;
      padding: 20px;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
    }
    .contact-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: #1e293b;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
    }
    .contact-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    .call-button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 0.9rem;
      cursor: pointer;
      width: 100%;
      margin-top: 4px;
    }

    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #dc2626;
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    .alert-text {
      font-size: 4.2rem;
      font-weight: 800;
      margin-bottom: 30px;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      line-height: 1.1;
    }
    .alert-close {
      background: white;
      color: #dc2626;
      border: none;
      padding: 18px 36px;
      border-radius: 30px;
      font-size: 1.6rem;
      cursor: pointer;
      width: 80%;
      max-width: 500px;
    }

    .datetime-bottom {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 1.2rem;
      text-align: right;
      z-index: 15;
      color: #fff;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
      display: none;
    }
  </style>
</head>
<body>
  <!-- Barre sup√©rieure -->
  <div class="top-bar">
    <button class="sos-button" onclick="sendEmergencyAlert()">üÜò</button>
    <div class="clock-box">
      <div class="clock" id="clock">--:--</div>
      <div class="date" id="date">Chargement...</div>
    </div>
    <button id="slideshowToggle" class="sos-button">üñºÔ∏è</button>
  </div>

  <!-- Diaporama -->
  <div id="slideshow" class="slideshow" onclick="toggleSlideshow()">
    <img id="slideshowImage" src="" alt="Diaporama">
  </div>

  <!-- Heure + Date en bas √† droite pendant le diaporama -->
  <div class="datetime-bottom" id="datetimeBottom">
    <div id="slideshowClock">--:--</div>
    <div id="slideshowDate">Chargement...</div>
  </div>

  <!-- Contacts en grille -->
  <div id="contactsGrid" class="contacts-grid"></div>

  <!-- Alertes -->
  <div id="alertOverlay" class="alert-overlay">
    <div class="alert-text" id="alertText">M√©dicaments !</div>
    <button class="alert-close" onclick="closeAlert()">Fermer</button>
  </div>

  <!-- Bouton "Je vais bien" en bas √† gauche -->
  <button id="okButton" class="ok-button" style="position:fixed; bottom:20px; left:20px; z-index:101;">‚úÖ</button>

  <script>
    const CONFIG = {
      contactsUrl: "https://gist.githubusercontent.com/benmanager/da95f2da3ec4ddaffc52e3bd34bfd378/raw/contacts.json",
      remindersUrl: "https://gist.githubusercontent.com/benmanager/3dfb352e5785852810c404c4677609be/raw/rappels.json",
      birthdaysUrl: "https://gist.githubusercontent.com/benmanager/4700824ff52de1824320cd4c6b307baa/raw/anniversaires.json",
      photosUrl: "https://gist.githubusercontent.com/benmanager/4e4573f17ffe42055337add296f9dcf8/raw/photos.json",
      alertsUrl: "https://gist.githubusercontent.com/benmanager/e82bd06a735c51e6bb40df788765af3f/raw/alerts.json"
    };

    let slideshowActive = false;
    let slideshowInterval = null;
    let photos = [];
    let slideshowPaused = false;

    // üñºÔ∏è Chargement des photos
    async function loadPhotos() {
      try {
        const data = await fetchJson(CONFIG.photosUrl);
        photos = data.photos || [];
        if (photos.length > 0) startSlideshow();
      } catch (e) { console.error("Photos:", e); }
    }

    function startSlideshow() {
      clearInterval(slideshowInterval);
      slideshowActive = true;
      document.getElementById('slideshow').style.display = 'flex';
      document.getElementById('datetimeBottom').style.display = 'block';
      
      let index = 0;
      slideshowInterval = setInterval(() => {
        if (photos.length === 0 || slideshowPaused) return;
        document.getElementById('slideshowImage').src = photos[index];
        index = (index + 1) % photos.length;
        updateSlideshowClock();
      }, 10000);
      
      if (photos.length > 0) {
        document.getElementById('slideshowImage').src = photos[0];
      }
    }

    function stopSlideshow() {
      clearInterval(slideshowInterval);
      slideshowActive = false;
      document.getElementById('slideshow').style.display = 'none';
      document.getElementById('datetimeBottom').style.display = 'none';
    }

    function toggleSlideshow() {
      if (slideshowActive) stopSlideshow();
      else startSlideshow();
    }

    function updateSlideshowClock() {
      const now = new Date();
      document.getElementById('slideshowClock').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('slideshowDate').textContent = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    // üó£Ô∏è Synth√®se vocale fiable
    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        speechSynthesis.speak(utterance);
      }
    }

    // üîä Son d'alerte
    function playAlertSound() {
      const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
      audio.play().catch(() => {});
    }

    // üö® Alertes
    function showAlert(message) {
      clearInterval(slideshowInterval);
      slideshowActive = false;
      document.getElementById('topBar').style.display = 'flex';
      document.getElementById('alertText').textContent = message;
      document.getElementById('alertOverlay').style.display = 'flex';
      playAlertSound();
      speak(message);
    }

    function closeAlert() {
      document.getElementById('alertOverlay').style.display = 'none';
      if (photos.length > 0) {
        startSlideshow();
      }
    }

    // SOS
    async function sendEmergencyAlert() {
      const message = `üö® ALERTE URGENCE\nJe suis en danger.\nAdresse : 17 Avenue de la haute Borne 02600 Villers-Cotter√™ts`;
      try {
        const url = `https://api.twilio.com/2010-04-01/Accounts/ACa9f5dfd00be492d52fae2479e85d8cfe/Messages.json`;
        const data = new URLSearchParams({ To: "+33680244077", From: "+13613216376", Body: message });
        await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': 'Basic YUNhOWY1ZGZkMDBiZTQ5MmQ1MmZhZTI0NzllODVkOGNmOjU3M2QyYjU0MTkxOTEyYTEwYzk1NjBmMjI0NzkwMmQxY2E=',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: data
        });
      } catch (e) { console.error("Erreur Twilio:", e); }
      showAlert("ALERTE D'URGENCE ENVOY√âE !");
    }

    // ‚úÖ Bouton "Je vais bien" (2 clics rapides)
    let clickCount = 0;
    let lastClickTime = 0;
    document.getElementById('okButton').addEventListener('click', () => {
      const now = Date.now();
      if (now - lastClickTime > 1500) {
        clickCount = 1;
      } else {
        clickCount++;
      }
      lastClickTime = now;

      if (clickCount === 2) {
        clickCount = 0;
        const message = "‚úÖ Je vais bien ‚Äì Myrianne";
        const url = `https://api.twilio.com/2010-04-01/Accounts/ACa9f5dfd00be492d52fae2479e85d8cfe/Messages.json`;
        const data = new URLSearchParams({ To: "+33680244077", From: "+13613216376", Body: message });
        fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': 'Basic YUNhOWY1ZGZkMDBiZTQ5MmQ1MmZhZTI0NzllODVkOGNmOjU3M2QyYjU0MTkxOTEyYTEwYzk1NjBmMjI0NzkwMmQxY2E=',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: data
        });
        document.getElementById('okButton').innerHTML = 'üíô';
        setTimeout(() => document.getElementById('okButton').innerHTML = '‚úÖ', 2000);
      }
    });

    // Contacts (double-tap sur l‚Äô√©cran)
    document.body.addEventListener('dblclick', () => {
      const overlay = document.getElementById('contactsGrid');
      if (overlay.style.display === 'grid') {
        overlay.style.display = 'none';
        return;
      }
      loadContactsForGrid();
      overlay.style.display = 'grid';
      setTimeout(() => { overlay.style.display = 'none'; }, 12000);
    });

    async function loadContactsForGrid() {
      try {
        const data = await fetchJson(CONFIG.contactsUrl);
        const container = document.getElementById('contactsGrid');
        container.innerHTML = data.contacts.map(contact => `
          <div class="contact-card">
            <img src="${contact.photo || 'https://via.placeholder.com/80'}" class="contact-photo" onerror="this.src='https://via.placeholder.com/80?text=Photo'">
            <div class="font-bold text-xl">${contact.name}</div>
            ${contact.phone ? `<button class="call-button" onclick="callPhone('${contact.phone}')"><i class="fas fa-phone mr-2"></i>Appel</button>` : ''}
            ${contact.video ? `<button class="call-button" onclick="callVideo('${contact.video}')"><i class="fas fa-video mr-2"></i>Vid√©o</button>` : ''}
          </div>
        `).join('');
      } catch (e) { console.error("Contacts:", e); }
    }

    function callPhone(phone) { window.location.href = `tel:${phone}`; }
    function callVideo(url) {
      if (url.includes('wa.me')) {
        const phoneNumber = url.match(/wa\.me\/(\d+)/)?.[1];
        if (phoneNumber) {
          window.location.href = `whatsapp://send?phone=${phoneNumber}`;
          setTimeout(() => window.location.href = `https://api.whatsapp.com/send?phone=${phoneNumber}`, 800);
        }
      } else if (url.startsWith('fb-messenger://')) {
        window.location.href = url;
      }
    }

    // Horloge
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('date').textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Alertes auto
    async function checkReminders() {
      try {
        const now = new Date();
        const currentTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const reminders = await fetchJson(CONFIG.remindersUrl);
        for (const r of reminders.reminders || []) {
          const jour = r.jour?.toLowerCase();
          if ((jour === 'tous' || jour === now.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase()) && r.heure === currentTime) {
            showAlert(r.texte);
            return;
          }
        }
        const birthdays = await fetchJson(CONFIG.birthdaysUrl);
        for (const b of birthdays.birthdays || []) {
          const birthDate = new Date(b.date);
          if (birthDate.getMonth() === now.getMonth() && birthDate.getDate() === now.getDate()) {
            showAlert(`üéÇ ANNIVERSAIRE ${b.nom.toUpperCase()} !`);
            return;
          }
        }
      } catch (e) { console.error("Alertes:", e); }
    }

    // Alertes manuelles
    let lastAlertTimestamp = 0;
    async function checkManualAlert() {
      try {
        const data = await fetchJson(CONFIG.alertsUrl + "?t=" + Date.now());
        if (data.alert && data.timestamp > lastAlertTimestamp) {
          lastAlertTimestamp = data.timestamp;
          showAlert(data.alert);
        }
      } catch (e) { console.error("Alerte manuelle:", e); }
    }

    async function fetchJson(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Erreur ${response.status}`);
      return await response.json();
    }

    // D√©marrage
    async function init() {
      await loadPhotos();
      checkReminders();
      setInterval(checkReminders, 30000);
      setInterval(checkManualAlert, 10000);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manager S√©nior</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    .night-mode {
      background: #111;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 16px;
      z-index: 100;
    }
    .sos-button, .ok-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sos-button { background: rgba(255,50,50,0.9); color: white; }
    .ok-button { background: rgba(34,197,94,0.9); color: white; }

    .slideshow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .slideshow img {
      max-width: 95%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    }

    .datetime-bottom {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 1.2rem;
      text-align: right;
      z-index: 15;
      color: #fff;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
      display: none;
    }

    .contacts-row {
      position: fixed;
      top: 80px;
      left: 10px;
      right: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      z-index: 90;
      padding: 10px;
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
    }
    .contact-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #1e293b;
      border-radius: 8px;
      width: 180px;
      text-align: center;
    }
    .contact-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .call-btn {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-right: 4px;
    }

    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #dc2626;
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    .alert-text {
      font-size: 4.2rem;
      font-weight: 800;
      margin-bottom: 30px;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .alert-close {
      background: white;
      color: #dc2626;
      border: none;
      padding: 18px 36px;
      border-radius: 30px;
      font-size: 1.6rem;
      cursor: pointer;
      width: 80%;
      max-width: 500px;
    }
  </style>
</head>
<body>
  <!-- Barre sup√©rieure -->
  <div class="top-bar">
    <button class="sos-button" id="sosButton">üÜò</button>
    <button class="sos-button" id="slideshowToggle">üñºÔ∏è</button>
  </div>

  <!-- Diaporama -->
  <div id="slideshow" class="slideshow" onclick="toggleSlideshow()">
    <img id="slideshowImage" src="" alt="Diaporama">
  </div>

  <!-- Heure + Date en bas √† droite -->
  <div class="datetime-bottom" id="datetimeBottom">
    <div id="slideshowClock">--:--</div>
    <div id="slideshowDate">Chargement...</div>
  </div>

  <!-- Contacts en ligne -->
  <div id="contactsRow" class="contacts-row"></div>

  <!-- Alertes -->
  <div id="alertOverlay" class="alert-overlay">
    <div class="alert-text" id="alertText">M√©dicaments !</div>
    <button class="alert-close" onclick="closeAlert()">Fermer</button>
  </div>

  <!-- Bouton "Je vais bien" en bas √† gauche -->
  <button class="ok-button" id="okButton" style="position:fixed; bottom:20px; left:20px; z-index:101;">‚úÖ</button>

  <script>
    // üîë Secrets Twilio
    const TWILIO_CONFIG = {
      sid: "ACa9f5dfd00be492d52fae2479e85d8cfe",
      token: "573d2b5419191a1c9ab56f40d2c1cf0a",
      from: "+13613216376",
      to: "+33680244077",
      address: "17 Avenue de la haute Borne 02600 Villers-Cotter√™ts"
    };

    const CONFIG = {
      contactsUrl: "https://gist.githubusercontent.com/benmanager/da95f2da3ec4ddaffc52e3bd34bfd378/raw/contacts.json",
      remindersUrl: "https://gist.githubusercontent.com/benmanager/3dfb352e5785852810c404c4677609be/raw/rappels.json",
      birthdaysUrl: "https://gist.githubusercontent.com/benmanager/4700824ff52de1824320cd4c6b307baa/raw/anniversaires.json",
      photosUrl: "https://gist.githubusercontent.com/benmanager/4e4573f17ffe42055337add296f9dcf8/raw/photos.json",
      alertsUrl: "https://gist.githubusercontent.com/benmanager/e82bd06a735c51e6bb40df788765af3f/raw/alerts.json"
    };

    let slideshowActive = false;
    let photos = [];

    // üåô Mode nuit automatique
    function checkNightMode() {
      const hour = new Date().getHours();
      if (hour >= 22 || hour < 7) {
        document.body.classList.add('night-mode');
      } else {
        document.body.classList.remove('night-mode');
      }
    }
    setInterval(checkNightMode, 60000);
    checkNightMode();

    // üñºÔ∏è Diaporama
    async function loadPhotos() {
      try {
        const data = await fetchJson(CONFIG.photosUrl);
        photos = data.photos || [];
        if (photos.length > 0) startSlideshow();
      } catch (e) { console.error("Photos:", e); }
    }

    function startSlideshow() {
      slideshowActive = true;
      document.getElementById('slideshow').style.display = 'flex';
      document.getElementById('datetimeBottom').style.display = 'block';
      updateSlideshowClock();
      let index = 0;
      setInterval(() => {
        if (photos.length === 0) return;
        document.getElementById('slideshowImage').src = photos[index];
        index = (index + 1) % photos.length;
        updateSlideshowClock();
      }, 10000);
      if (photos.length > 0) {
        document.getElementById('slideshowImage').src = photos[0];
      }
    }

    function stopSlideshow() {
      slideshowActive = false;
      document.getElementById('slideshow').style.display = 'none';
      document.getElementById('datetimeBottom').style.display = 'none';
    }

    function toggleSlideshow() {
      if (slideshowActive) stopSlideshow();
      else startSlideshow();
    }

    function updateSlideshowClock() {
      const now = new Date();
      document.getElementById('slideshowClock').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('slideshowDate').textContent = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    // üó£Ô∏è Voix + Son
    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        utterance.rate = 0.9;
        speechSynthesis.speak(utterance);
      }
    }
    function playAlertSound() {
      const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
      audio.play().catch(() => {});
    }

    // üö® Alertes
    function showAlert(message) {
      stopSlideshow();
      document.getElementById('alertText').textContent = message;
      document.getElementById('alertOverlay').style.display = 'flex';
      playAlertSound();
      speak(message);
    }
    function closeAlert() {
      document.getElementById('alertOverlay').style.display = 'none';
      if (photos.length > 0) startSlideshow();
    }

    // SOS - 2 clics
    let sosClicks = 0;
    document.getElementById('sosButton').addEventListener('click', () => {
      sosClicks++;
      setTimeout(() => { sosClicks = 0; }, 1500);
      if (sosClicks === 2) {
        sosClicks = 0;
        const message = `üö® ALERTE URGENCE\nJe suis en danger.\nAdresse : ${TWILIO_CONFIG.address}`;
        sendTwilioMessage(message);
        showAlert("ALERTE D'URGENCE ENVOY√âE !");
      }
    });

    // Je vais bien - 2 clics
    let okClicks = 0;
    document.getElementById('okButton').addEventListener('click', () => {
      okClicks++;
      setTimeout(() => { okClicks = 0; }, 1500);
      if (okClicks === 2) {
        okClicks = 0;
        const message = "‚úÖ Je vais bien ‚Äì Myrianne";
        sendTwilioMessage(message);
        document.getElementById('okButton').innerHTML = 'üíô';
        setTimeout(() => document.getElementById('okButton').innerHTML = '‚úÖ', 2000);
      }
    });

    function sendTwilioMessage(message) {
      const url = `https://api.twilio.com/2010-04-01/Accounts/${TWILIO_CONFIG.sid}/Messages.json`;
      const data = new URLSearchParams({ To: TWILIO_CONFIG.to, From: TWILIO_CONFIG.from, Body: message });
      fetch(url, {
        method: 'POST',
        headers: { 'Authorization': 'Basic ' + btoa(`${TWILIO_CONFIG.sid}:${TWILIO_CONFIG.token}`) },
        body: data
      });
    }

    // Contacts en ligne
    async function loadContactsInLine() {
      try {
        const data = await fetchJson(CONFIG.contactsUrl);
        const container = document.getElementById('contactsRow');
        container.innerHTML = data.contacts.map(contact => `
          <div class="contact-card">
            <img src="${contact.photo || 'https://via.placeholder.com/40'}" class="contact-photo" onerror="this.src='https://via.placeholder.com/40?text=Photo'">
            <div style="flex:1; font-size:0.9rem;">
              <div style="font-weight:700; margin-bottom:4px;">${contact.name}</div>
              <div>
                ${contact.phone ? `<button class="call-btn" onclick="callPhone('${contact.phone}')">üìû</button>` : ''}
                ${contact.video ? `<button class="call-btn" onclick="callVideo('${contact.video}')">üìπ</button>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error("Contacts:", e); }
    }

    function callPhone(phone) { window.location.href = `tel:${phone}`; }
    function callVideo(url) {
      if (url.includes('wa.me')) {
        const phoneNumber = url.match(/wa\.me\/(\d+)/)?.[1];
        if (phoneNumber) {
          window.location.href = `whatsapp://send?phone=${phoneNumber}`;
          setTimeout(() => window.location.href = `https://api.whatsapp.com/send?phone=${phoneNumber}`, 800);
        }
      }
    }

    // Alertes auto + manuelles
    async function checkReminders() {
      try {
        const now = new Date();
        const currentTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const reminders = await fetchJson(CONFIG.remindersUrl);
        for (const r of reminders.reminders || []) {
          const jour = r.jour?.toLowerCase();
          if ((jour === 'tous' || jour === now.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase()) && r.heure === currentTime) {
            showAlert(r.texte);
            return;
          }
        }
        const birthdays = await fetchJson(CONFIG.birthdaysUrl);
        for (const b of birthdays.birthdays || []) {
          const birthDate = new Date(b.date);
          if (birthDate.getMonth() === now.getMonth() && birthDate.getDate() === now.getDate()) {
            showAlert(`üéÇ ANNIVERSAIRE ${b.nom.toUpperCase()} !`);
            return;
          }
        }
      } catch (e) { console.error("Alertes:", e); }
    }

    let lastAlertTimestamp = 0;
    async function checkManualAlert() {
      try {
        const data = await fetchJson(CONFIG.alertsUrl + "?t=" + Date.now());
        if (data.alert && data.timestamp > lastAlertTimestamp) {
          lastAlertTimestamp = data.timestamp;
          showAlert(data.alert);
        }
      } catch (e) { console.error("Alerte manuelle:", e); }
    }

    async function fetchJson(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Erreur ${response.status}`);
      return await response.json();
    }

    // D√©marrage
    async function init() {
      await loadPhotos();
      await loadContactsInLine();
      checkReminders();
      setInterval(checkReminders, 30000);
      setInterval(checkManualAlert, 10000);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
